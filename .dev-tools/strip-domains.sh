#!/bin/bash
# Sort Domain into a plain text file with domain names only
# Created by: Mitchell Krog (mitchellkrog@gmail.com)
# Copyright: Mitchell Krog - https://github.com/mitchellkrogza
# Repo Url: https://github.com/mitchellkrogza/The-Big-List-of-Hacked-Malware-Web-Sites

#Specify Input and Output File
# ****************************
_input=$TRAVIS_BUILD_DIR/.input_sources/hacked-malware-websites.txt
_input2=$TRAVIS_BUILD_DIR/.dev-tools/domains_tmp.txt
_output=$TRAVIS_BUILD_DIR/.dev-tools/_strip_domains/domains.txt

# Truncate our file
# *****************
sudo truncate -s 0 $_output

# Use cut to strip the domains out of the url strings
# ***************************************************
cut -d'/' -f3 $_input > $_output

# **************************************************************************
# Sort lists alphabetically and remove duplicates before cleaning Dead Hosts
# **************************************************************************

sort -u $_output -o $_output

# *****************
# Activate Dos2Unix
# *****************

dos2unix $_output

# ******************************************
# Trim Empty Line at Beginning of Input File
# ******************************************

grep '[^[:blank:]]' < $_output > $_input2
sudo mv $_input2 $_output

# ********************************************************
# Clean the list of any lines not containing a . character
# ********************************************************

cat $_output | sed '/\./!d' > $_input2 && mv $_input2 $_output

# **************************************************************************************
# Strip out our Dead Domains / Whitelisted Domains and False Positives from CENTRAL REPO
# **************************************************************************************


# *********************************************************************************************************************************************************
# First Run our Cleaner to remove all Dead Domains from https://github.com/mitchellkrogza/CENTRAL-REPO.Dead.Inactive.Whitelisted.Domains.For.Hosts.Projects
# *********************************************************************************************************************************************************

printf '\n%s\n%s\n%s\n\n' "##########################" "Stripping out Dead Domains" "##########################"

sudo wget https://raw.githubusercontent.com/mitchellkrogza/CENTRAL-REPO.Dead.Inactive.Whitelisted.Domains.For.Hosts.Projects/master/dead-domains.txt -O $TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/dead-domains.txt

_deaddomains=$TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/dead-domains.txt
_deadtemp=$TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/temp_dead_domains.txt

sort -u $_deaddomains -o $_deaddomains
sort -u $_output -o $_output

awk 'NR==FNR{a[$0];next} !($0 in a)' $_deaddomains $_output > $_deadtemp && mv $_deadtemp $_output

sort -u $_output -o $_output

printf '\n%s\n%s\n%s\n\n' "###############################" "END: Stripping out Dead Domains" "###############################"

# *******************************************************************************************************************************************************************
# Run our Cleaner to remove all False Positive Domains from https://github.com/mitchellkrogza/CENTRAL-REPO.Dead.Inactive.Whitelisted.Domains.For.Hosts.Projects
# *******************************************************************************************************************************************************************

printf '\n%s\n%s\n%s\n\n' "####################################" "Stripping out False Positive Domains" "####################################"

sudo wget https://raw.githubusercontent.com/mitchellkrogza/CENTRAL-REPO.Dead.Inactive.Whitelisted.Domains.For.Hosts.Projects/master/false-positives.txt -O $TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/false-positives.txt

_falsepositives=$TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/false-positives.txt
_falsepositivestemp=$TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/temp_false_positives.txt

sort -u $_falsepositives -o $_falsepositives

awk 'NR==FNR{a[$0];next} !($0 in a)' $_falsepositives $_output > $_falsepositivestemp && mv $_falsepositivestemp $_output

sort -u $_output -o $_output

printf '\n%s\n%s\n%s\n\n' "#########################################" "END: Stripping out False Positive Domains" "#########################################"

# *******************************************************************************************************************************************************************
# Run our Cleaner to remove all Whitelisted Domains from https://github.com/mitchellkrogza/CENTRAL-REPO.Dead.Inactive.Whitelisted.Domains.For.Hosts.Projects
# *******************************************************************************************************************************************************************

printf '\n%s\n%s\n%s\n\n' "#################################" "Stripping out Whitelisted Domains" "#################################"

sudo wget https://raw.githubusercontent.com/mitchellkrogza/CENTRAL-REPO.Dead.Inactive.Whitelisted.Domains.For.Hosts.Projects/master/whitelist-domains.txt -O $TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/whitelist-domains.txt

_whitelist=$TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/whitelist-domains.txt
_whitelisttemp=$TRAVIS_BUILD_DIR/.input_sources/.False-Positives-Dead-Domains/temp_whitelisted.txt

sort -u $_whitelist -o $_whitelist

awk 'NR==FNR{a[$0];next} !($0 in a)' $_whitelist $_output > $_whitelisttemp && mv $_whitelisttemp $_output

sort -u $_output -o $_output

printf '\n%s\n%s\n%s\n\n' "######################################" "END: Stripping out Whitelisted Domains" "######################################"

# ************************************************
# Activate Dos2Unix One Last Time and Re-Sort List
# ************************************************

dos2unix $_output

exit 0

